---
title: "Effect of Environmental Predictors on Horn Sizes of Male and Female Chamois in the Eastern Italian Alps"
author: "Franz Johann, Liangwen He, Matthias Theobald"
date: "18. December 2015"
output: 
  html_document: 
    keep_md: yes
    number_sections: yes
    toc: yes
---

```{r echo=F, include=FALSE}
library(knitr)
library(mgcv)
library(Hmisc)
library(psych)
```

# Introduction

Our research question was whether environmental variables affect the horn size of male and female chamois differently. Further we investigated which predictors are the main drivers for different horn sizes between males and females.


## About the data
We have received a data set of 2679 observations from hunted animals of the species *Rupicapra rupicapra* (Chamois) in the Eastern Italian Alps in the region of Alto Adige (South Tirol). The shot animals are yearlings culled during the hunting season of their second year. The hunting season is from September to December. The data measured from each individual is 

- horn length in mm,
- weight in kg,
- sex,
- Year and Julian Day of the culling, as well as
- Council and Area Code.


Also included in the data set is the council where the animal was shot, which in turn belongs to one of five administrative areas. Furthermore, there are environmental data, aggregated at either council or area level.

Many of the data refer to specific time span of the life of the yealing chamois.

<img src="imgs/zeitleisteaus.jpg" width="1000">

## Description of Environmental Data

Because of problems with the data we have one value for temperature, precipitation and snow for each season covered by the life history of the killed individual for the study area. There is also information about the global climate scale North Atlantic Oscillation(NAO) index.

At area level there is substrate with two categories: siliceous and calcareous. Animal density is supplied per year which is then either confirmed in the next year or changed.

We have the geographic coordinate, elevation and aspect for each council. Also recorded is the Percentage of open area in the council. The Normalized Difference Vegetation Index (NDVI) is used as an indicator for food supply.

## Struggling with Data

The first data set we received only included partial weather data. First, we wanted to know about the weather conditions of the winter during the pregnancy of the mother (first winter) but we only had data about the weather of the winter the yearling experienced (second winter).
Second, there was no weather data about the autumn the yearling experienced.
Third, while exploring the data, we found several inconsistencies in the weather data.

Because of that, we asked for a larger data set including the weather data of the first winter during pregnancy and also asked for clarification on the issues with the weather station. We received a second data set where the requested information was provided, but 1100 observations of shot animals were removed, so only 1560 were available. The researchers responsible for the data argued that the removed data was probably not reliable. Our argument though is that each and every observation is useful and should be included in the model. We therefore set out to work on merging the two data sets and filling the holes in the first set with meaningful weather data from the second.

We received information from the curators of the data about the weather stations they used for the different areas. the When trying to bring the two data sets together we found that the relationships between the weather data of different areas are unsteady, although they should have shared the same stations. It turned out that since not all stations were working consistently throughout the study some areas had to borrow weather data from other area. This is a serious problem, we can now no more maintain that the weather data for each council is true.
To deal with this problem, we try to find out one council sample, which on one side has insisted with the weather data from one station continuously from 2005 to 2012, and on the other side can be representative of the whole research area considering its elevation(finally council 39). Then we generalizing its weather data to the whole research area for each year. At last we would introduce an interaction between elevation and aspect, which should reflect the true variance of weather in different councils.

## Loading the data sets into R

```{r loading data}
# helper function: inverse of intersect
outersect <- function(x, y) {
    sort(c(setdiff(x, y),
        setdiff(y, x)))
}

# read data
db_chamois1 <- read.csv("chamois1.csv", sep=";")
db_chamois2 <- read.csv("chamois2.csv", sep=";")


#rename columns so merging can work its magic
# in the new data set, a "2"" is appended at the end of the columns names
db_chamois1$Snow_cover_winter2 <- db_chamois1$Snow_cover_winter
db_chamois1$snow_winter2 <- db_chamois1$snow_winter
db_chamois1$twinter.max2 <- db_chamois1$twinter.max
db_chamois1$twinter.mean2 <- db_chamois1$twinter.mean
db_chamois1$twinter.min2 <- db_chamois1$twinter.min

# delete the old columns
db_chamois1$Snow_cover_winter <- NULL
db_chamois1$snow_winter <- NULL
db_chamois1$twinter.max <- NULL
db_chamois1$twinter.mean <- NULL
db_chamois1$twinter.min <- NULL

# delete columns excel has added
db_chamois2$X <- NULL
db_chamois2$X.1 <- NULL
db_chamois2$X.2 <- NULL
```

After loading the data we face the problem that the second data set has less observations than the first. 

```{r number of observations}
# number of observations in each data set
nrow(db_chamois1); nrow(db_chamois2)
```

There is evironmental data, especially weather data in the second data set that we want to use for all observations of the first.

First we merge the two sets, keeping all observations.
```{r merging data}
# merge the databases
db_merge <- merge(db_chamois1, db_chamois2, all.x=T)

# delete all unnecessary columns
drops <- c(
    "data", # date as string
    "exc.date2", # excel numeric date
    "Julia.date", # year + Julian day
    "date", # year + Julian day + random number
    "x", # coordniates + small random step for spatial analysis
    "y", # same
    "x2", # same
    "y2", # same
    "y_r", #same
    "x_r", #same
    "NS", # North-south facing component of aspect
    "EO", # East-West facing component of aspect
    "Nweight", # normalized weight
    "Nhorn", # normalized horn length
    "h_w", # ratio hor length to weight
    "index" # Indice of above ratio
)

# drop unnecessary columns
db_merge <- db_merge[, !names(db_merge) %in% drops]

```

These are the columns present in the new merged data.

```{r db_merge names, echo=F}
names(db_merge)
```

These 15 columns are not present in the first first set.

```{r outersect table, echo=F}
# what columns are new in the new data set?
outersect(colnames(db_chamois1), colnames(db_chamois2))
```

Our first approach was to take the weather data from the areas present in the second data (area 1 and 6) set and put them in the same area of the first set. We then wanted to interpolate over elevation to get new values for those areas not in the second set (area 2, 3, and 4).

```{r areas in the first and second set}
unique(db_chamois1$area_cod)
unique(db_chamois2$area_cod)
```

We need to take values from the second set and include them in the first set. Here the problem is that the use of weather stations is inconsistent, as well as some of the stations are not present in all councils and some councils use weather data from a station which is unsuitable to represent the whole study area.


```{r fixing weather}

# make weather data consistent
# select all weather data
weather_data <- c(
    "snow_winter1",
    "Snow_cover_winter1",
    "r_apr_mag_1",
    "r_giu_lug_1",
    "r_ago_set_1",
    "r_spring1",
    "r_newsummer1",
    "r_autumn",
    "snow_winter2",
    "Snow_cover_winter2",
    "r_apr_mag_2",
    "r_giu_lug_2",
    "r_ago_set_2",
    "r_spring2",
    "r_newsummer2",
    "twinter.min1",
    "twinter.max1",
    "twinter.mean1",
    "tspring1.min",
    "tspring1.max",
    "tspring1.mean",
    "tsummer1.min",
    "tsummer1.max",
    "tsummer1.mean",
    "tautumn.min",
    "tautumn.max",
    "tautumn.mean",
    "twinter.min2",
    "twinter.max2",
    "twinter.mean2",
    "tspring2.min",
    "tspring2.max",
    "tspring2.mean",
    "tsummer2.min",
    "tsummer2.max",
    "tsummer2.mean"
)
```

Now, we first have to check in which councils chamois were hunted each year.
```{r consistency check}
# consistency of kills in councils: not every year a chamois was shot in every council
with(db_merge, tapply(horn, list(council_cod, year), length))
# we need the consistent council to select which weather data to use
```

Councils 27, 10, 8 39 and 49 are ok and use weather data from statsions with continuous measurements throughout the study.

The data from council 39 and 49 are from the weather station *Pinzolo Val Genova*, which we deem best for representing the wohle study area. We picked council 39 for our purpose.

```{r weather stations}
# weather data from council 27 for each year
station27 <- unique(db_merge[db_merge$council_cod==27, c("year", weather_data)]) # not okay: year2007
# for the weather data in autumn, council27 has 2 values for the year 2007
station10 <- unique(db_merge[db_merge$council_cod==10, c("year", weather_data)])
station8 <- unique(db_merge[db_merge$council_cod==8, c("year", weather_data)])
# the weather stations used in council 8 and 10 are not representative for the whole area

station39 <- unique(db_merge[db_merge$council_cod==39, c("year", weather_data)]) # ok, snow, T, and Prec are from the higher stations both
station49 <- unique(db_merge[db_merge$council_cod==49, c("year", weather_data)]) # same as 39
# representative!


# merge the new weather data set into the old one
# removing the old weather columns first
db <- merge(db_merge[, !names(db_merge) %in% weather_data], station39, by="year", all=F)
```

Lastly, we remove columns of variables which are either updated or removed in the new data set because they have errors.

```{r remove columns}
# remove the old summer precipitation data
db$r_summer_1 <- NULL
db$r_summer_2 <- NULL

# remove old may ndvi. it's incorrect
db$ndvi.may1 <- NULL
db$ndvi.may2 <- NULL
```

A quick check for NA in the new data set:
```{r check for NA}
# check for NA
with(db, tapply(snow_winter1, year, function(y) sum(is.na(y))))
summary(db$snow_winter2)
summary(db$r_autumn)
summary(db$tautumn.min)
# No NAs!
```

```{r include=FALSE}
# aspect is an unreliable predictor since its not equally distributed
# include aspect as factr: facing south and facing north
db$aspect <- as.factor(ifelse(db$asp < 90 | db$asp > 270, "N", "S"))

# transform sex to factors
db$f.sex <- as.factor(db$sex)
levels(db$f.sex) <- c("female", "male") # relevel sex

#transform substrate to factors
db$f.substrate <- as.factor(db$substrate)
levels(db$f.substrate) <- c("sili", "calc")

#factorize year
db$f.year <- as.factor(db$year)

# factorize council code
db$f.council_cod <- as.factor(db$council_cod)


#calculate log ndvi slope
head(sort(unique(db$ndvi.slop1)))
db$log.ndvi.slop1 <- log(db$ndvi.slop1 + 0.5*0.001)
db$log.ndvi.slop2 <- log(db$ndvi.slop2)

# add q_range to db
db$q_range <- db$q_max - db$q_min


# add pca for ndvi
# attach(db)
# may ndvis
pca1 <- with(db, prcomp(cbind(ndvi.may1.new, ndvi.may2.new), scale=T))
summary(pca1)
# two PCS explain enough variance
round(pca1$rotation, 2)
# biplot(pca1)

# all ndvis
pca2 <- with(db, prcomp(cbind(ndvi.may1.new, ndvi.may2.new, ndvi.summer1, ndvi.summer2), scale=T))
summary(pca2)
# two are enough
# biplot(pca2)

# summer ndvis
pca3 <- with(db, prcomp(cbind(ndvi.summer1, ndvi.summer2), scale=T))
summary(pca3)
# pc1 is enough
# biplot(pca3)

# ndvi year one and ndvi year two seperated
pca4.1 <- with(db, prcomp(cbind(ndvi.may1.new, ndvi.summer1), scale=T))
pca4.2 <- with(db, prcomp(cbind(ndvi.may2.new, ndvi.summer2), scale=T))

summary(pca4.1)
summary(pca4.2)
# for both, pc1 is enough
cor(pca4.1$x[, 1], pca4.2$x[, 1])
# cannot use both, highly correlated


# PCA of NDVI may year 1 and 2
db$ndvi.m1m2.pc1 <- pca1$x[, 1]
db$ndvi.m1m2.pc2 <- pca1$x[, 2]

# PCA of NDVI of summer year 1 and 2 and may year 1 and 2
db$ndvi.m1m2s1s2.pc1 <- pca2$x[, 1]

# PCA of NDVI of summer year 1 and 2
db$ndvi.s1s2.pc1 <-pca3$x[, 1]

# PCA of NDVI may1 and summer 1
db$ndvi.m1s1.pc1 <- pca4.1$x[, 1]
# PCA of NDVI may2 and summer 2
db$ndvi.m2s2.pc1 <- pca4.2$x[, 1]






# drop weight > 25kg
# yearlings are NOT that heavy!
nrow(subset(db, weight > 25))
db <- subset(db, weight < 25)


save(db, file="db.RData")

```


We now have a data set with `r nrow(db)` observations and `r ncol(db) - 1` variables as potential predictors.


# Methods and Material

## Data Exploration


```{r sex as factor, echo=F}
# sex as factor
db$f.sex <- as.factor(db$sex)
levels(db$f.sex) <- c("female", "male") # relevel sex
summary(db$f.sex)
```

Of the `r nrow(db)` animals, 1218 are female and 1461 are male.

### Horn length

As our dependent variable, we wanted to know how horn length varies between sexes.

First, we wanted to see the distribution of Horn size.
```{r horn distr}
summary(db$horn)
hist(db$horn, breaks=40, freq=FALSE, main="Hornlength", xlab= "Length [mm]")
lines(density(db$horn), lwd=1.5,lty =2)
```

Our dependent variable semms to be very close to normally distributed. However, we wanted to see whether the same holds true for the horn length between sexes.

Mean horn length of male and female and dfifference between sexes:
```{r horn sex mean}
(horn_sex <- with(db, tapply(horn, f.sex, mean)))
diff(horn_sex)
```

```{r horn length sd}
boxplot(horn~f.sex, data = db, main= "Hornlength ",ylab= "length [mm]", xlab= "sex")
```

There are some data points far outside, but we accept them as still being within natural variability.

```{r}
hist(db$horn[db$sex==1],breaks=40,freq=FALSE,col=rgb(1,0,0,0.1), main="Hornlength", xlab= "Length [mm]")
hist(db$horn[db$sex==2],breaks=40,freq=FALSE,add=TRUE,col=rgb(0,0,1,0.1))
lines(density(db$horn[db$sex==1]), col="red", lwd=2,lty =2)
lines(density(db$horn[db$sex==2]), col="blue", lwd=2, lty =1)
legend("topright",lwd=c(2,2), lty= c(2,1),col=c("red","blue"),legend=c("female", "male"))
```

Also horn lengths between sexes are close to normally distributed.

```{r}
with(db, tapply(horn, f.sex, sd))
```

Males show a higher variability of horn length in general, although the difference is fairly small.

Here we wanted to see how horn lengths differ over the years between the sexes.
```{r horn length year sd}
# change over the years
(horn_sexyear <- with(db, tapply(horn, list(year, f.sex), mean)))
apply(horn_sexyear, 2, summary)
apply(horn_sexyear, 2, sd)
# males show less variance in mean horn length over the years
```

There is some variability over the years that suggests using year as random effect in our model later on. However, males show less variability in horn lengths over the years than females.

```{r}
boxplot(horn~year, dat=db, main = "Hornlength", xlab="Year", ylab= "Hornlength")

```

In different years the distribution of hornlength is different. The models need a random effect for year.

### Weight

Weight is measured in kilograms of the empty (i.e. gutted) yearling.

```{r summary weight}
summary(db$weight)
```

We deem an empty weight of more than 25 kg as too heavy for a yearling. Their mean weight is at around 15 kg. We therefore removed five individuals heavier than 25 kg from the data set.

```{r remove too heavy animals}
nrow(subset(db, weight > 25))
db <- subset(db, weight < 25)
```

Distribution of weight:
```{r weight distr}
summary(db$weight)
hist(db$weight, breaks=40, freq=F, xlab= "Weight [kg]", main="")
hist(db$weight[db$sex==1],breaks=20,freq=FALSE,col=rgb(1,0,0,0.1), add=T)
hist(db$weight[db$sex==2],breaks=20,freq=FALSE,add=TRUE,col=rgb(0,0,1,0.1))

lines(density(db$weight), lwd=2, lty=3)
lines(density(db$weight[db$sex==1]), col="red", lwd=2, lty = 2)
lines(density(db$weight[db$sex==2]), col="blue", lwd=2, lty=1)
legend("topright",lwd=c(2,2,2),lty= c(1,2,3), col=c("red","blue", "black"),legend=c("female", "male", "both"))
```

Weight has a strange distribution. Plotting the data reveals why.

```{r}
plot(horn ~ weight, data=db, main="Horn ~ Weight", xlab="Weight [kg]", ylab="Horn length [mm]")
```

The plot of horn length against weight shows some anomaly because of different scales of measurement. We analysed the scale detail of the data.

```{r classifiying weight}
# Problems with integers and floats in weight data
# selecting all weight data which are whole numbers
tol <- 1e-12
int_weight <- rep(0, nrow(db))

int_weight[sapply(db$weight, function(y) min(abs(c(y%%1, y%%1-1))) < tol)] <- 1

sum(int_weight) # whole numbers in weight
length(int_weight) - sum(int_weight) # floating point numbers

# are the integers and floating point weigths evenly distributed over the areas?

plot(with(db, tapply(int_weight, area_cod, function(y) sum(y)/length(y) * 100)), type="h", cex=1.4, main="Weight: perentage of integers", xlab="Area", ylab="")
```

In Some areas (or councils) the weight seems to be either guessed or the carcass is weighed on a scale displaying only whole nuembers. Although we thought about reclassifying weight data, we did not have enough time to include that in our models.


Like horn size we wanted to see the difference of weight between sexes.

```{r differences in weight between sexes}
## differences in weight between sexes
(weight_sex <- with(db, tapply(weight, f.sex, mean)))
diff(weight_sex) # difference = 0.3 kg

#graphical
boxplot(weight~f.sex, data = db, ylab= "Weight [kg]", xlab= "sex")
# but males have a higher variance in weight for the individuals
```

The difference in mean weight is not as substantial as the difference in mean horn length between sexes. However, males have a higher  median weight.

```{r change of weight over years}
(weight_sexyear <- with(db, tapply(weight, list(year, f.sex), mean)))
apply(weight_sexyear, 2, summary)
apply(weight_sexyear, 2, sd)

```

As in horn length, males show a smaller variance in mean weight over the years than females.

### Julian Day

Julian Day is the day of year the animal was shot. The hunting season begins in September and ends at the end of the year. It is consistent over the years.

```{r}
range(db$Jday)#[1] 247 364
max(db$Jday) - min(db$Jday)#timespan 117 days
with(db, tapply(Jday, year, min))
with(db, tapply(Jday, year, max))
```

There is an 

```{r}
fgam1 <- gam(weight ~ s(Jday, bs="ts") + s(council_cod, bs="re") + s(year, bs="re"), data=db)
summary(fgam1)
plot(fgam1, select=1)
```
Apparantly the weight increases over the hunting period until ~ day 300 when it rapidly drops. This could  be explained that before October the animals find enough grass for feeding and grwoing, while later the winter has set on and they start to burn their body fat reserves. However, the effect is really small.


```{r}
Julgam1<-gam(weight~s(Jday, bs="ts") + f.sex + s(council_cod, bs="re") + s(year, bs="re"), data=db)
vis.gam(Julgam1, plot.type="persp", theta=-145, main="Weight ~ Julianday + Sex",zlab="weight", xlab="female       male",ylab="Day of Hunting Season")
summary(Julgam1)
```







#### effect of Julian day on horn length  male & female

Loess of horn length depending on Julianday for fmale and female:

```{r}
male <- subset(db, sex == 2)
female <- subset(db, sex == 1)

fmLoess_Jday_m <- loess(male$horn~male$Jday,family="gaussian",span=0.8)
newday_m <- seq(from=min(male$Jday), to=max(male$Jday),by=1)
pred_Horn_m <- predict(fmLoess_Jday_m, newday_m, se=TRUE)
plot(male$horn~male$Jday, main ="Loess: Horn~Julianday",ylab="Hornlength [mm]",xlab="Day of the year",pch=1)
lines(pred_Horn_m$fit~newday_m,col="blue", lwd=2)

fmLoess_Jday_f <- loess(female$horn~female$Jday,family="gaussian",span=0.8)
newday_f <- seq(from=min(female$Jday), to=max(female$Jday),by=1)
pred_Horn_f <- predict(fmLoess_Jday_f, newday_f, se=TRUE)
lines(pred_Horn_f$fit~newday_f,col="red", lwd=2, lty=2)

abline(h=140,col="darkgreen",lwd=2,lty=3)
abline(h=160,col="darkgreen",lwd=2,lty=3)
legend("topright",lwd=c(2,2,2),lty=c(1,2,3),col=c("blue","red","darkgreen"),legend=c("male","female", "fix value 140 mm & 160 mm"),cex=0.8)
```

Loess regression shows a decreasing hornlength at the beginning of the hunting season and increasing hornlength after day 275



### Elevation



```{r}
hist (db$q_media,main= "Elevation",freq=FALSE, xlab="elevation a.s.l. [m]")
lines(density(db$q_media), col="purple", lwd=3)

```

The samples are not well distributed.


Analyse horn denpending on elevation

```{r}
attach(db)

tapply(horn,area_cod,mean)    
tapply(q_media,area_cod,mean)


mean (horn)# 142.1995
sd(horn)#20.58488


detach(db)
```

Animals hunted  at the lowest elevation area have the biggest mean horn length.
Animals originating from the highest area have the smalest average horn length. There is a difference of 20.7015 mm between this groups. Thist span is 29% of the (overall) average horn length. The standard deviation of horn length is 20.6 mm

LOESS Horn Elevation

```{r}

fmLoess_HE_m <- loess(male$horn~male$q_media,family="gaussian",span=0.75)
newEle_m <- seq(from=min(male$q_media), to=max(male$q_media),by=1)
pred_H_m <- predict(fmLoess_HE_m, newEle_m, se=TRUE)
plot(db$horn~db$q_media, main ="Loess Regression: Horn~Elevation",ylab="horn [mm]",xlab="Elevation [m a.s.l.]",pch=1)
lines(pred_H_m$fit~newEle_m,col="blue", lwd=2)


fmLoess_HE_f <- loess(female$horn~female$q_media,family="gaussian",span=0.75)
newEle_f <- seq(from=min(female$q_media), to=max(female$q_media),by=1)
pred_H_f <- predict(fmLoess_HE_f, newEle_f, se=TRUE)

lines(pred_H_f$fit~newEle_f,col="red", lwd=2,lty =2)
legend("topright",lwd=c(2,2),lty=c(1,2),col=c("blue","red"),legend=c("male","female"))

```

The visualisition of LOESS regression shows decreasing horn length with the increase of elevation. Futhermore, it suggests that this decrease is in female stronger.  

combined plot of two lines for glm male and female with fixed further variables

```{r}
attach(db)

male_db <- male
female_db <- female

Glmhorn_m<-glm(horn ~ q_media + weight + Jday + ndvi.summer1 + Perc.area.aperta, data=male_db, family="gaussian")
summary(Glmhorn_m)#Estimate  q_media  -0.008671


Glmhorn_f<-glm(horn~q_media+weight+Jday+ndvi.summer1+Perc.area.aperta,data=female_db,family="gaussian")
summary(Glmhorn_f)#Estimate  q_media  --0.009838






newele_f<- seq(from=min(female_db$q_media), to=max(female_db$q_media), len=100)

Preds_f<-predict(Glmhorn_f, newdata=data.frame("q_media"=newele_f, "weight"=median(female_db$weight), "Jday"=median(female_db$Jday), "ndvi.summer1"=median(female_db$ndvi.summer1), "Perc.area.aperta"=median(female_db$Perc.area.aperta)),se=TRUE)

newele_m<- seq(from=min(male_db$q_media), to=max(male_db$q_media), len=100)

Preds_m<-predict(Glmhorn_m, newdata=data.frame("q_media"=newele_m, "weight"=median(male_db$weight), "Jday"=median(male_db$Jday), "ndvi.summer1"=median(male_db$ndvi.summer1), "Perc.area.aperta"=median(male_db$Perc.area.aperta)), se=TRUE)


with(db, plot(horn ~ q_media, main= "LM Hornlength", xlab="Elevation", ylab="Hornlenght [mm]"))
lines(Preds_f$fit~newele_f, col="red", lwd =2, lty =2)
lines(Preds_m$fit~newele_m, col="blue",lwd =2, lty =1)
legend("topright",lwd=c(2,2,2,2),lty= c(1,2,3,3),col=c("blue","red","blue","red"),legend=c("male","female","conf. male"," conf.female"))
text(c(900,900),c(122,180), labels =c("-0.009838", "-0.008671"), col= c("red","blue"))
lines(newele_m,Preds_m$fit+1.96*Preds_m$se.fit,col="blue",lwd =2, lty =3)
lines(newele_m,Preds_m$fit-1.96*Preds_m$se.fit,col="blue",lwd =2, lty =3)
lines(newele_f,Preds_f$fit+1.96*Preds_f$se.fit,col="red",lwd =2, lty =3)
lines(newele_f,Preds_f$fit-1.96*Preds_f$se.fit,col="red",lwd =2, lty =3)

detach(db)
```

With increasing elevation female hornlength decreases slightly more than in male chamois.
But the difference is small regarding the confidence intervall. This linear model does not include random effects.The suggested effect of elevation has to be further analyised.







### Councils and spatial distributions

We wanted to see the spatial distribution of the councils, as well as the spatial distribution for our main predictors.

```{r spatial distribution of weight}
fm_spatial_weight <- gam(weight ~ s(x.council, y.council), data=db)
vis.gam(fm_spatial_weight, plot.type="contour", main="Weight", xlab="x coords", ylab="y coords")
points(db$x.council, db$y.council, col=db$area_cod, pch=20, cex=1.6)
legend("bottomright", legend=paste("Area", unique(db$area_cod)), col=unique(db$area_cod), pch=20)
```

```{r elevation, unweighted and interpolated!}
# interpolated elevation 
fm_spatial_ele <- gam(q_media~s(x.council, y.council), data=db)
vis.gam(fm_spatial_ele, plot.type = "contour", main="Elevation", xlab="x coords", ylab="y coords")
points(db$x.council, db$y.council, col=db$area_cod, pch=20, cex=1.6)
legend("bottomright", legend=paste("Area", unique(db$area_cod)), col=unique(db$area_cod), pch=20)
```

The spatial distribution suggests that our models might have spatial autocorrelation.

Also, the distribution of councils and aggregation of data at council levels suggests that we should include councils as random factor besides years.

```{r kills in councils}
t(with(db, tapply(horn, council_cod, length)))

```

Council 15 has the most hunted anmimals

```{r}

hist(db$council_cod, breaks=length(unique(db$council_cod)), main="kills per council", xlab="council")

with(db, tapply(horn, list(council_cod, year), length))

```

Also consistently over the years, council 15 has the most kills per year.


## Random Forest analyses

```{r,include=FALSE}
library(randomForest)
```

For analysing the importance of variabels we used Randomforest.




```{r,message=FALSE, warnings=FALSE}
both_sexes<-randomForest(horn ~ (sex) + (x.council) + (y.council) + (Jday) + (q_media) + (q_min) + (weight) + f.substrate + (density) + (ndvi.slop1) + (ndvi.maxincr1) + (ndvi.may1.new) + (ndvi.summer1) + (ndvi.summer2) + (ndvi.slop2) + (ndvi.maxincr2) + (Perc.area.aperta) + (snow_winter1) + (aspect) + (r_newsummer1) + (snow_winter2) + (r_spring2) + (r_newsummer2) + (twinter.mean1) + (tspring1.mean) + (tsummer1.mean) + (twinter.mean2) + (tspring2.mean) + (tsummer2.mean), ntree=500, data=db)
varImpPlot(both_sexes)
```

Sex, weight and the day of hunting (Julianday) are by far the most relevant variables.

For a better understanding of the importance of the less relevant factors the variables weight and Julianday are ommitted in the following randomforest analysis and analysis are performed sex separated.

Randomforest for male chamois and plot of variable importance:

```{r}


male<-randomForest(horn ~(x.council) + (y.council) + (q_media) + (q_min) + f.substrate + (density) + (ndvi.slop1) + (ndvi.maxincr1) + (ndvi.may1.new) + (ndvi.summer1) + (ndvi.summer2) + (ndvi.slop2) + (ndvi.maxincr2) + (Perc.area.aperta) + (snow_winter1) + (aspect) + (r_newsummer1) + (snow_winter2) + (r_spring2) + (r_newsummer2) + (twinter.mean1) + (tspring1.mean) + (tsummer1.mean) + (twinter.mean2) + (tspring2.mean) + (tsummer2.mean), ntree=500, data=male_db)
varImpPlot(male)
```

RandomForest for female chamois and plot of variable importance:

```{r}
female<-randomForest(horn ~(x.council) + (y.council) + (q_media) + (q_min) + f.substrate + (density) + (ndvi.slop1) + (ndvi.maxincr1) + (ndvi.may1.new) + (ndvi.summer1) + (ndvi.summer2) + (ndvi.slop2) + (ndvi.maxincr2) + (Perc.area.aperta) + (snow_winter1) + (aspect) + (r_newsummer1) + (snow_winter2) + (r_spring2) + (r_newsummer2) + (twinter.mean1) + (tspring1.mean) + (tsummer1.mean) + (twinter.mean2) + (tspring2.mean) + (tsummer2.mean), ntree=500, data=female_db)
varImpPlot(female)
```


After sex, weight and Julianday the NDVI of summer and May, elevation (q_edia) and pecentage of open area have a high rank in the importance of variables. The rank of the variables differs in the male and female ranfomForest importance analyses.

## Collineatity Check

First, we test for correlation inside of logical groups of predictors. There we assume that a correlation coefficient lower than 0.7 for Pearsons r are not collinear. On the other hand, we use a varclus plot to indicate collinear clusters. The threshhold here is 0.5 for spearmans rho².




```{r,echo=FALSE, include=FALSE}
load("db.RData")
library(Hmisc)
library(psych)
attach(db)

```

### collinearity in elevation data

```{r, echo=FALSE}
pairs.panels(cbind(q_media, q_min, q_range, q_max))
```

Here only the existence of q_max is not good.

Then we think about transforming elevation relative to mean:

```{r, echo=FALSE}
q_relmin <- q_min - q_media
q_relmax <- q_max - q_media
pairs.panels(cbind(q_relmin, q_media, q_relmax))
```

This approach is worse :(


Conclusion: q_media, q_min and q_range are not collinear and can stay as pedictors for elevation.

### Collinearity of NAO and NAO with other climate data

```{r, echo = FALSE}
pairs.panels(cbind(nao_a1, nao_a2, nao_d, nao_f, nao_j, nao_m, nao_w))
```

NAO for months is correlated; NAO for winter, year1 and year2 could be useful.

How is the correlation of nao with temperature and precipitation?

```{r, echo=FALSE}


Tcor<- data.frame(twinter.mean2 = cor(db$nao_w, db$twinter.mean2), twinter.min2 = cor(db$nao_w, db$twinter.min2), twinter.max = cor(db$nao_w, db$twinter.max2), snow_winter2 = cor(db$nao_w, db$snow_winter2))
row.names(Tcor) <- "nao_w"
Tcor


```

NAO is correlated with minimum winter temperature and also with snow depth.


### Variable Clustering of all climate data

```{r, echo=FALSE}
f1 <- formula(horn ~ nao_a1 + nao_a2 + nao_w + r_apr_mag_1 + r_giu_lug_1 + r_ago_set_1 + r_apr_mag_2 + r_giu_lug_2 + r_ago_set_2 + r_spring1 + r_spring2 + r_newsummer1 + r_newsummer2 + r_autumn + snow_winter1 + snow_winter2 + Snow_cover_winter1 + Snow_cover_winter2 + twinter.min1 + twinter.max1 + twinter.mean1 + twinter.min2 + twinter.max2 + twinter.mean2 + tautumn.min + tautumn.max + tautumn.mean + tspring1.min + tspring1.max + tspring1.mean + tspring2.min + tspring2.max + tspring2.mean + tsummer1.min + tsummer1.max + tsummer1.mean + tsummer2.min + tsummer2.max + tsummer2.mean)

plot(varclus(f1, data=db))
abline(h=0.5, col="red")
```

A lot of climate predictors are highly collinear. some of them are not logically interpretable like r_spring1 with snow_cover_winter2.
And as there are too much information, how can we begin to simplify?
Another consideration is, since it can have a huge change of appearance after removing some variables, did VarClus really reflect all the relationships in an appropriate way?


After this small excursion to VarClus, we decide standing on the former approach: first check for correlation inside smaller groups.

### Collinearity in precipitation data

Rain inside two years seperately:

```{r, echo=FALSE}
prec1 <- cbind(r_apr_mag_1, r_giu_lug_1, r_ago_set_1, r_spring1, r_newsummer1, r_autumn)
prec2 <- cbind(r_apr_mag_2, r_giu_lug_2, r_ago_set_2, r_spring2, r_newsummer2)
pairs.panels(prec1, main="precipitation 1")
pairs.panels(prec2, main="precipitation 2")
```



Bimonthly precipitation for both years:

```{r, echo=FALSE}
prec_all <- cbind(r_apr_mag_1, r_giu_lug_1, r_ago_set_1, r_apr_mag_2, r_giu_lug_2, r_ago_set_2)
pairs.panels(prec_all)
```


They are all good except for r_ago_set and r_giu_lug2. Pick one, but test for both.



What about rain and snow inside this two years?

```{r, echo=FALSE}
pairs.panels(cbind(prec_all, snow_winter1, snow_winter2))
pairs.panels(cbind(prec_all, Snow_cover_winter1, Snow_cover_winter2))
```


Snow_cover_winter is not correlated with rain data, but by snow_winter is the case.

Approach: either bimonthly data or seasonal data
- high correlation between r_summer1 and r_autumn1
- bimonthly data is uncorrelated
-> so bimonthly precipitaion data might be better

### Collinearity in temperature data

- First Winter:

```{r, echo=FALSE}
winter1 <- cbind(horn, twinter.min1, twinter.mean1, twinter.max1)
pairs.panels(winter1, main = "Winter1")
```

ok

- Second winter:

```{r, echo=FALSE}
winter2 <- cbind(horn, twinter.min2, twinter.mean2, twinter.max2)
pairs.panels(winter2, main = "Winter2")
```

ok

- First spring:

```{r, echo=FALSE}
spring1 <- cbind(horn, tspring1.min, tspring1.mean, tspring1.max)
pairs.panels(spring1, main = "Spring1")
```

Here, everything can stay.

- Second spring

```{r, echo=FALSE}
spring2 <- cbind(horn, tspring2.min, tspring2.mean, tspring2.max)
pairs.panels(spring2, main = "Spring2")
```

Here, everything can stay.

- First summer:

```{r, echo=FALSE}
summer1 <- cbind(horn, tsummer1.min, tsummer1.mean, tsummer1.max)
pairs.panels(summer1, main = "summer1")
```

"tsummer1_mean" is highly correlated with both max and min. All three can not be used simultaneously.

- Second summer:

```{r,echo=FALSE}
summer2 <- cbind(horn, tsummer2.min, tsummer2.mean, tsummer2.max)
pairs.panels(summer2, main = "summer2")
```

Here, everything can stay.

- Autumn:

```{r, echo=FALSE}
autumn <- cbind(horn, tautumn.min, tautumn.mean, tautumn.max)
pairs.panels(autumn, main = "Autumn")
```

"tautumn.mean" with tautumn.max at the threshold




Conclusion so far:

- predictor for snow: snow_cover_winter

- predictor for Temperature:
       twinter.min1, twinter.mean1, twinter.max1
       twinter.min2, twinter.mean2, twinter.max2
       tspring1.min, tspring1.mean, tspring1.max
       tspring2.min, tspring2.mean, tspring2.max
       tsummer1.min, tsummer1.max
       tsummer2.min, tsummer2.mean, tsummer2.max
       tautumn.min, tautumn.mean, tautumn.max, but at threshold

- predictor for precipitation:
       r_apr_mag_1, r_giu_lug_1, r_apr_mag_2, r_ago_set_2
       either r_ago_set_1 or r_giu_lug_2

### Collnearity in NDVI

- NDVI in the first year:

```{r, echo=FALSE}
ndvi1 <- cbind(horn, ndvi.maxincr1, ndvi.may1.new, ndvi.slop1, ndvi.summer1)
ndvi2 <- cbind(horn, ndvi.maxincr2, ndvi.may2.new, ndvi.slop2, ndvi.summer2)

ndvi1 <- cbind(horn, ndvi.maxincr1, ndvi.may1.new, log.ndvi.slop1, ndvi.summer1)
ndvi2 <- cbind(horn, ndvi.maxincr2, ndvi.may2.new, log.ndvi.slop2, ndvi.summer2)
pairs.panels(ndvi1, main = "NDVI1", method = "pearson")

```

As expected, NDVI in may and summer are highly correlated. Pick One.

However, ndvi.slop is heavily skewed towards 0.

```{r}
summary(ndvi.slop1)
sum(ndvi.slop1 == 0) # only 1!
sum(ndvi.slop1 < 0.1) # but more then 2000 are smaller than 0.1
sum(ndvi.slop1 > 0.1)

```
Should we log transform?

```{r}
log.ndvi.slop1 <- log(ndvi.slop1 + 0.5*0.001)
hist(log.ndvi.slop1)
summary(log.ndvi.slop1)

```
 

- NDVI in the second year:

```{r, echo=FALSE}
pairs.panels(ndvi2, main = "NDVI2")

```

Same result for the second year: May and summer are highly correlated.

```{r}
summary(ndvi.slop2) # no zeros
log.ndvi.slop2 <- log(ndvi.slop2)
hist(log.ndvi.slop2)
```

- Both years together:

```{r, echo=FALSE}
ndvib <- cbind(ndvi.maxincr1, ndvi.may1.new, log.ndvi.slop1, ndvi.maxincr2, ndvi.may2.new, log.ndvi.slop2)
pairs.panels(ndvib, main = "both NDVI")
```


We then introduce the PCA method here, trying to deal the collinearity problem in NDVI data.


- PCA_may_ndvis:
```{r}
pca1 <- prcomp(cbind(ndvi.may1.new, ndvi.may2.new), scale=T)
summary(pca1)

```

Two PCs explain enough variance

```{r}
round(pca1$rotation, 2)
biplot(pca1)

```



- PCA_all_ndvis:

```{r}
pca2 <- prcomp(cbind(ndvi.may1.new, ndvi.may2.new, ndvi.summer1, ndvi.summer2), scale=T)
summary(pca2)

```

The first two PCs are enough.

```{r}
biplot(pca2)
```



- PCA_summer ndvis:

```{r}
pca3 <- prcomp(cbind(ndvi.summer1, ndvi.summer2), scale=T)
summary(pca3)

```

The first PC part is enough.

```{r}
biplot(pca3)
```




- ndvi_year_one and ndvi_year_two seperated:

```{r}
pca4.1 <- prcomp(cbind(ndvi.may1.new, ndvi.summer1), scale=T)
pca4.2 <- prcomp(cbind(ndvi.may2.new, ndvi.summer2), scale=T)

summary(pca4.1)
summary(pca4.2)

```

For both, the first PC part is enough.

```{r}
cor(pca4.1$x[, 1], pca4.2$x[, 1])

```


Cannot use both at the same time, highly correlated.


### Conclusion in collinnearity

In oder to get a global view of collinearity, we draw the picture below:

<img src="imgs/collinearity catalog2.png" width="1000">

We try to put the variable which have collinearity problem at the same level, so they should become the alternative for each other in a model components selection route, and then wouldn't bother each other. But since there is multi-collinearity we have to pick them out from the potential model which should include maximum possible variables already. According to this picture we have more than 9000 possible variable combinations, and they all need one more step collinearity check inside it. On the other hand when one of the collinear predictors explains something than the other collinear predictor would too. So it is also unnecessary to try all the possible combinations. 

# Results

## Tiny GAMs

Since our data exploration and random forest revealed that weight, sex and Julian day were explaining the most variance and our check for collinearity revealed that those remaining predictors were showing high collinearity, we decided to try an approach where we tested for each predictor in an independent model including mixed effects of year and council.

```{r include=FALSE}
library(mgcv)
library(sp)
library(Hmisc)

load("db.RData")
db_male <-subset(db, f.sex == "male")
db_female <-subset(db, f.sex == "female")
```

### Null model: random effects of year and council

```{r Null Model}
# Null Model:
# just with council code and year
fcham_t0 <- gam(horn ~ 1 + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t0) # Deviance explained = 12.4%
plot(fcham_t0, page=1, scale=F, all=T)
AIC(fcham_t0) # 23472.28
gam.check(fcham_t0)
```
The residuals already look fine, there might be a slight problem considering normality of the random intercepts, but it should be fine. However, considering the spatial nature of our data we might have spatial autocorrelation

```{r spatial autocrrelation null model}
# spatial autocorrelation
resids <-  residuals(fcham_t0)
resids.spdf <- SpatialPointsDataFrame(coords=cbind(db$x.council + runif(nrow(db), min=-300, max=300), db$y.council +  runif(nrow(db), min=-300, max=300)), data=data.frame(resids))
bubble(resids.spdf, maxsize=7)
# add random jitter to the bubbles to better see underlying colors
# all good
```

Including the councils as random effect already rids the model of spatial autocorrelation.

```{r temporal autocorrelation}
# check for temporal auocorrelation in the data
pacf(db$horn, main="Series of Horn length")
# all good

pacf(residuals(fcham_t0))
# all good
```

Although there definitely is temporal autocorrelation in the horn lengths, our null model shows no traces thereof.

### Adding sex to the null model

```{r gam sex}
fcham_t1 <- gam(horn ~ f.sex + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t1) # Deviance explained = 40.8%
plot(fcham_t1, page=1, scale=F, all=T)
AIC(fcham_t1) # 22431.79
gam.check(fcham_t1)
```

Including sex as the main driver, this model now explains 40.8% of deviance. The AIC is much better than the null model.

The effect of sex lies at 22.1 mm difference in horn length.



### Adding weight to the null model

```{r gam weight}
fcham_t2 <- gam(horn ~ s(weight, bs="ts") + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t2) # Deviance explained = 24.5%
plot(fcham_t2, page=1, scale=F)
AIC(fcham_t2) # 23085.26
gam.check(fcham_t2)
```

The residuals as well as the intercepts of our random intercepts don't look so good here, but are still 'OK'. Weight on itself does not explains as much deviance as sex does. The AIC lies between null model and sex model.


### Adding Julian day to the null model

The third most important predictor throughout our exploration seemed to be Julian day, the day of culling.

```{r gam Jday}
fcham_t3 <- gam(horn ~ s(Jday, bs="ts") + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t3) # Deviance explained = 13.5%
plot(fcham_t3, page=1, scale=F, all=T)
AIC(fcham_t3) # 23439.6
gam.check(fcham_t3)
```

Julian day has a clear linear effect on horn size. This makes sense because the horn of the animals still keeps on growing during the hunting season. Because of its linearity, Julian day can and should be moved to the linear part of the model.

```{r gam Jday linear}
fcham_t3.1 <- gam(horn ~ Jday + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t3.1) # Deviance explained = 13.5%
plot(fcham_t3.1, page=1, scale=F, all=T)
AIC(fcham_t3.1) # 23439.43
```

The effect lies at about 0.09 mm per day. 

### Testing for interactions between predictors

We had a strong intuition that sex and weight might be interacting, but also wanted to test for other interactions between those three predictors. 

First, we tested for weight*sex. We added sex as a predictor without interactions to get a baseline and then added the interaction.

```{r weight and sex}
fcham_t2.1 <- gam(horn ~ f.sex + s(weight, bs="ts") + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t2.1) # Deviance explained = 49.6%
plot(fcham_t2.1, page=1, scale=F)
AIC(fcham_t2.1) # 22006.7

fcham_t2.2 <- gam(horn ~ f.sex + s(weight, bs="ts", by=f.sex) + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t2.2) # Deviance explained = 50.2%
plot(fcham_t2.2, page=1, scale=F)
AIC(fcham_t2.2) # 21980.35
vis.gam(fcham_t2.2, theta=-35)

```

There is a significant interaction between weight and sex that adds explanatory power added to the model. The here AIC is 20 points lower than for the model without interaction.

we then tested for an interaction between Julian day and sex. Again, the same strategy as before was followed.

```{r Jday and sex}
fcham_t3.2 <- gam(horn ~ Jday + f.sex + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t3.2) # Deviance explained = 42.7%
plot(fcham_t3.2, page=1, scale=F, all=T)
AIC(fcham_t3.2) # 22347.01

fcham_t3.3 <- gam(horn ~ Jday*f.sex + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t3.3) # Deviance explained = 42.7%
plot(fcham_t3.3, page=1, scale=F, all=T)
AIC(fcham_t3.3) # 22348.68
```

There is no interaction between sex and Julian day evident. 

Lastly the interaction between weight and Julian day.

```{r weight and Jday}
fcham_t2.3 <- gam(horn ~ s(Jday, bs="ts") + s(weight, bs="ts") + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t2.3) # Deviance explained = 25.9%
plot(fcham_t2.3, page=1, scale=F, all=T)
AIC(fcham_t2.3) # 23036.67

fcham_t2.4<- gam(horn ~ s(weight, Jday, bs="ts", by=f.sex) + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t2.4) # Deviance explained = 24.2%
plot(fcham_t2.4, page=1, scale=F, all=T)
AIC(fcham_t2.4) # 23093.55
vis.gam(fcham_t2.4, theta=-35)
```

Although the interaction is significant, the AIC of the interaction model is worse than the model without interaction.

We then decided on a final model structure for our basic model.

### Final model structure


```{r weight, sex and Jday}
# weight, sex and Jday
fcham_t4 <- gam(horn ~ f.sex + Jday + s(weight, bs="ts", by=f.sex) + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=F)
summary(fcham_t4) # Deviance explained = 52.4%
AIC(fcham_t4) # 21862.54 best so far

#check the gam
gam.check(fcham_t4) # all good
shapiro.test(resid(fcham_t4)) # good
acf(residuals(fcham_t4)) # all good
# spatial autocorrelation
resids <-  residuals(fcham_t4)
resids.spdf <- SpatialPointsDataFrame(coords=cbind(db$x.council + runif(nrow(db), min=-300, max=300), db$y.council +  runif(nrow(db), min=-300, max=300)), data=data.frame(resids))
bubble(resids.spdf, maxsize=7)
# all good!
```

There is no autocorrelation in this model, neither temporal nor spatial.

```{r}
# weight, sex and Jday
fcham_t4 <- gam(horn ~ f.sex + Jday + s(weight, bs="ts", by=f.sex) + s(f.year, bs="re") + s(f.council_cod, bs="re"), data=db, REML=T)
summary(fcham_t4) # Deviance explained = 52.4%
AIC(fcham_t4) # 21862.54 best so far
```

With REML=T nothing changes.
Now this model explains 52.4% of deviance which, as we will later see, is about the same as a full model with lots of environmental predictors can explain.

From here on we followed to approaches: 

 1. We built a full model including as many predictors as possible without running into collineraity issues (complex GAMs). We then split the data set into females and males, using the complex model and doing model selection, trying to find the most important environmental predictor for either sex.
 2. We added single environmental predictors one after the other to the above final model structure and looked for a better model fit (simple GAMs). We then tested for interactions of that environmental predictor with sex to see if males and females react differently to that predictor.
 
## Simple GAMs

### Substrate as predictor

The first environmental predictor we tested was substrate. With this data a paper has been published, claiming that substrate is a main driver in horn size of Chamois.

```{r substrate}
fcham_e1 <- update(fcham_t4, . ~ . + f.substrate)
summary(fcham_e1) # Deviance explained = 52.3%
plot(fcham_e1, page=1, scale=F, all=T)
AIC(fcham_e1) # 21858.87
AIC(fcham_t4) # 21862.54
# slightly better!
```

Substrate is a significant predictor, however the model only gets slightly better (delta AIC < 4)

We then tested for an interaction between substrate and sex.

```{r substrate and sex}
fcham_e1.1 <- update(fcham_t4, . ~ . + f.substrate*f.sex)
summary(fcham_e1.1) # Deviance explained = 40.7%
plot(fcham_e1.1, page=1, scale=F, all=T)
AIC(fcham_e1.1) # 21860.8
# No interaction!!
```

There is no interaction


### Elevation as predictor

Next is mean elevation. During exploration we thought this predictor might be the most important after sex, weight and Julian day.

```{r}
fcham_e2 <- update(fcham_t4, . ~ . + s(q_media, bs="ts"))
summary(fcham_e2) # Deviance explained = 52.4%
plot(fcham_e2, page=1, all=T)
AIC(fcham_e2) # 21860.11
AIC(fcham_t4) # 21862.54
# no difference
```

Again, although mean elevation is a significant predictor, it does not make the model predictions better compared to the final model structure (delta AIC < 3)

Interaction elevation and sex:
 
```{r}
fcham_e2.1 <- update(fcham_t4, . ~ . + s(q_media, bs="ts", by=f.sex))
summary(fcham_e2.1) # Deviance explained = 52.3%
plot(fcham_e2.1, page=1, all=T)
AIC(fcham_e2) # 21860.07
AIC(fcham_t4) # 21862.54
# no difference
```

There is no significant interaction.

We also had minimum and maximum elevation as drivers for horn size in the random forest model (without random effects)


```{r}
fcham_e2.2 <- update(fcham_t4, . ~ . + s(q_min, bs="ts"))
summary(fcham_e2.2) # Deviance explained = 52.4%
plot(fcham_e2.2, page=1, all=T)
AIC(fcham_e2.2) # 21862.48
AIC(fcham_t4) # 21862.54
# no difference
```

```{r}
fcham_e2.3 <- update(fcham_t4, . ~ . + s(q_max, bs="ts"))
summary(fcham_e2.3) # Deviance explained = 52.4%
plot(fcham_e2.3, page=1, all=T)
AIC(fcham_e2.3) # 21862.53
AIC(fcham_t4) # 21862.54
# no difference
```


Both minimum and maximum elevation add nothing to the model.

### NDVI as predictor

We used the first two principal components of NDVI of May in the first and second year.

```{r}
fcham_e3 <- update(fcham_t4, . ~ . + s(ndvi.m1m2.pc1, bs="ts") + s(ndvi.m1m2.pc2, bs="ts"))
summary(fcham_e3) # Deviance explained = 53.1%
plot(fcham_e3, page=1, scale=F)
AIC(fcham_e3) # 21844.74
AIC(fcham_t4) # 21862.54
# there is a difference here
gam.check(fcham_e3)
```

This added some explanatory power to the model. However, the GAM fitted a spline with more than 7 edf to the data. This is not interpretable as a predictor.
We therefor tried reducing the knots for the spline to see the effects more clearly.

```{r}
fcham_e3.1 <- update(fcham_t4, . ~ . + s(ndvi.m1m2.pc1, bs="ts", k=4) + s(ndvi.m1m2.pc2, bs="ts", k=4))
summary(fcham_e3.1) # Deviance explained = 53.1%
plot(fcham_e3.1, page=1, scale=F)
AIC(fcham_e3.1) # 21859.16
AIC(fcham_t4) # 21862.54
# there is a difference here
gam.check(fcham_e3)
```

Now the effect is gone. Although the effect of the first principal component of NDVI is still significant, the model power is not better than the final model (delta AIC < 4).

### Winter weather data

All winter data except for snow are uncorrelated and can be included in the model.

```{r}
fcham_e4 <- update(fcham_t4, . ~ . + s(twinter.min1, bs="ts", k=6) + s(twinter.min2, bs="ts", k=6) + s(twinter.mean1, bs="ts", k=6) + s(twinter.mean2, bs="ts", k=6) + s(twinter.max1, bs="ts", k=6) + s(twinter.max2, bs="ts", k=6) + s(Snow_cover_winter1, bs="ts", k=6) + s(Snow_cover_winter2, bs="ts", k=6))
summary(fcham_e4) # Deviance explained = 53.1%
plot(fcham_e4, page=1, scale=F)
AIC(fcham_e4) # 21861.54
AIC(fcham_t4) # 21862.54
# there is a difference here
gam.check(fcham_e4)
```

Again, some predictors like Snow duration during both winters and maximum winter temperatures are significant predictors, but they are adding nothing to the model in terms of deviance explained.


### Summary
At this point, we ran out of time to try for more combinations, but the picture seems to be clear. Most variance is explained by three main predictors sex, weight and Julian day.










## Male and female separated Gams 


Loading the mgcv library

```{r,message = FALSE}
library(mgcv)

```
Loading the database and creating separated datasets for male and female chamois respectively
```{r}

load("db.RData")
male_db<-subset(db,sex ==  2)
female_db<-subset(db,sex == 1)

```
Building different gams based on gam "c5" with a set of variables which had been found as being best explaining the horngrowth by using a wide range of explaining variables.

Randomforest had revealed weight, julianday, elevation (q_media), ndvi summer, ndvi may and percentage of open area as relevant factors. Ndvi may, ndvi summer, elevation and percentage of open area are not included in the model so far. Different models which include one of the additional environmental variables could reveal by AIC analysis different importance of the variables for the different sexes.

### NDVI

Different principal component analysis vectors had been build for vegetation indices (ndvi):

- may year 1 and may year2
- summer year 1 and summer year 2
- may year 1 and summer year 1
- may year 2 and summer year 2

see data handling.

#### NDVI PCA May year 1 and May year 2

Testing for correlation of model variables in the male and female subsets.

```{r,message = FALSE, warning=FALSE}
library(Hmisc)
attach(female_db)
attach(male_db)
```

```{r}

vFx1 <- as.formula(horn ~

                       Jday +
                       f.substrate +
                       year +
                       council_cod +
                       weight +
                       density +
                       log.ndvi.slop1 +
                       log.ndvi.slop2 +
                       ndvi.maxincr1 +
                       ndvi.maxincr2 +
                       ndvi.m1m2.pc1 +
                       ndvi.m1m2.pc2 + 
                       snow_winter1 +
                       snow_winter2 +
                       r_newsummer1 +
                       r_newsummer2 +
                       twinter.mean1 +
                       twinter.mean2 +
                       tspring1.mean +
                       tspring2.mean +
                       tsummer1.mean +
                       tsummer2.mean +
                       tautumn.mean)
par(mfrow=c(1,1))
plot(varclus(vFx1, data=female_db))
abline(h=0.5,col="red")


vMx1 <- as.formula(horn ~
                     
                     Jday +
                     f.substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.m1m2.pc1 +
                     ndvi.m1m2.pc2 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vMx1, data=male_db))
abline(h=0.5,col="red")

```

t_summer1.mean and snow winter2 are correlated in male and female.
r_newsummer1 and tautum.mean are correlated in male and female.
Correlating variables will be excuded and seperated models will be tested with replaced variables 

- t_summer1.mean or snow winter2
- r_new summer1 or tautumn.mean

Loading models.
load
```{r,message =FALSE}
load(file="sex_sep_models.Rdata")
```

Model omitting snow-winter2 and r_newsummer1 

Male model:

```{r,eval=FALSE}
  M_x1.1 <-  gam(horn ~
                 
                 s(density,k=3, bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(Jday,bs="ts") + 
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

)



```
```{r}
AIC(M_x1.1)
```


Female model:
```{r,eval=FALSE}
F_x1.1 <-  gam(horn ~
                 s(density,k=3, bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(Jday,bs="ts") + 
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)




```

```{r}
AIC(F_x1.1)
```
Checking the model

```{r}
gam.check(F_x1.1)

```
Rename for plotting routine and plot effects
```{r}
MOD_F<-(F_x1.1)
MOD_M<-(M_x1.1)

par(mfrow=c(1,2))

plot(MOD_F,main="female",all=T,select=1)
plot(MOD_M,main="male",all=T,select=1)

plot(MOD_F,main="female",all=T,select=2)
plot(MOD_M,main="male",all=T,select=2)

plot(MOD_F,main="female",all=T,select=3)
plot(MOD_M,main="male",all=T,select=3)

plot(MOD_F,main="female",all=T,select=4)
plot(MOD_M,main="male",all=T,select=4)

plot(MOD_F,main="female",all=T,select=5)
plot(MOD_M,main="male",all=T,select=5)

plot(MOD_F,main="female",all=T,select=6)
plot(MOD_M,main="male",all=T,select=6)

plot(MOD_F,main="female",all=T,select=7)
plot(MOD_M,main="male",all=T,select=7)

plot(MOD_F,main="female",all=T,select=8)
plot(MOD_M,main="male",all=T,select=8)

plot(MOD_F,main="female",all=T,select=9)
plot(MOD_M,main="male",all=T,select=9)

plot(MOD_F,main="female",all=T,select=10)
plot(MOD_M,main="male",all=T,select=10)

plot(MOD_F,main="female",all=T,select=11)
plot(MOD_M,main="male",all=T,select=11)

plot(MOD_F,main="female",all=T,select=12)
plot(MOD_M,main="male",all=T,select=12)

plot(MOD_F,main="female",all=T,select=13)
plot(MOD_M,main="male",all=T,select=13)

plot(MOD_F,main="female",all=T,select=14)
plot(MOD_M,main="male",all=T,select=14)

plot(MOD_F,main="female",all=T,select=15)
plot(MOD_M,main="male",all=T,select=15)

plot(MOD_F,main="female",all=T,select=16)
plot(MOD_M,main="male",all=T,select=16)

plot(MOD_F,main="female",all=T,select=17)
plot(MOD_M,main="male",all=T,select=17)

plot(MOD_F,main="female",all=T,select=18)
plot(MOD_M,main="male",all=T,select=18)

plot(MOD_F,main="female",all=T,select=19)
plot(MOD_M,main="male",all=T,select=19)

plot(MOD_F,main="female",all=T,select=20)
plot(MOD_M,main="male",all=T,select=20)

plot(MOD_F,main="female",all=T,select=21)
plot(MOD_M,main="male",all=T,select=21)
```

The same procedure ommitting different combinations of the collinear climate variables.
```{r,eval=FALSE}

M_x1.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
                 #s(tautumn.mean, k=3, bs="ts"),
               ,data=male_db, REML=F)

AIC(M_x1.2)# 11923.48

F_x1.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
                 #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x1.2)# 9922.036

#omitting  tsummer1.mean and r_newsummer1

M_x1.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x1.3)# 11926.67

F_x1.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x1.3)# 9923.202

#############
#omitting  tsummer1.mean and tautumn.mean

M_x1.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2, k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
                 #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x1.4)#  11926.67

F_x1.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1m2.pc1,k=4, bs="ts") +
                 s(ndvi.m1m2.pc2,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
                 #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x1.4)# 9921.959


```

An overview of the AIC´s will be presented in a table furter below.

#### NDVI PCA Summer 1 and summer 2

Check for collinearity
```{r}
vMx2 <- as.formula(horn ~
                     
                     Jday +
                     substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.s1s2.pc1 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vMx2, data=male_db))
abline(h=0.5,col="red")

vFx2 <- as.formula(horn ~
                     
                     Jday +
                     substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.s1s2.pc1 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vFx2, data=female_db))
abline(h=0.5,col="red")

```

Corelations are the same as in the previous models.

 - t_summer1.mean und snow winter2 correlated in male and female
 - r_newsummer1 and tautum.mean correlated in male and female
 
The same procedure as with NDVI May1 and May2. 4 models for male and 4 models for female ommitting different combinations of collinear climate variables.

```{r,eval=FALSE}

M_x2.1 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x2.1)# 11925.25

F_x2.1 <-  gam(horn ~
                 s(Jday,bs="ts")+
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x2.1)# 9923.85
#model omitting snow winter and tautumn.mean

M_x2.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
                 #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x2.2)#  11925.9

F_x2.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=2, bs="ts") +
                 s(ndvi.s1s2.pc1,k=2, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x2.2)# 9922.789

#omitting  tsummer1.mean and r_newsummer1

M_x2.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x2.3)# 11927.6

F_x2.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x2.3)# 9925.405

#############
#omitting  tsummer1.mean and tautumn.mean

M_x2.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x2.4)# 11927.6

F_x2.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.s1s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x2.4)# 9925.488
```


#### NDVI PCA May and summer of the first year

Check for collinearity

```{r}
vMx3 <- as.formula(horn ~
                     
                     Jday +
                     substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.m1s1.pc1 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vMx3, data=male_db))
abline(h=0.5,col="red")

vFx3 <- as.formula(horn ~
                     
                     Jday +
                     substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.m1s1.pc1 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vFx3, data=female_db))
abline(h=0.5,col="red")

```

same as with previous PCA
t_summer1.mean und snow winter2 correlated in male and female
r_newsummer1 and tautum.mean correlated in male and female

The same procedure as above. Running 4 models for male and 4 models for female ommitting different combinations of collinear climate variables.

```{r,eval=FALSE}
M_x3.1 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x3.1)#  11926.46

F_x3.1 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x3.1)# 9924.476

#model omitting snow winter and tautumn.mean

M_x3.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x3.2)# 11926.46

F_x3.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x3.2)#9922.43 

#omitting  tsummer1.mean and r_newsummer1

M_x3.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density, k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x3.3)#11928.63

F_x3.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x3.3)# 9921.486

#############
#omitting  tsummer1.mean and tautumn.mean

M_x3.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x3.4)# 11928.61

F_x3.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m1s1.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x3.4)#9921.486
 
```

#### NDVI PCA May and summer of the second year


Collinearity check

```{r}
vMx4 <- as.formula(horn ~
                     
                     Jday +
                     substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.m2s2.pc1 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vMx4, data=male_db))
abline(h=0.5,col="red")

vFx4 <- as.formula(horn ~
                     
                     Jday +
                     substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     ndvi.m2s2.pc1 + 
                     snow_winter1 +
                     snow_winter2 +
                     r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     tsummer1.mean +
                     tsummer2.mean +
                     tautumn.mean)

plot(varclus(vFx4, data=female_db))
abline(h=0.5,col="red")


```

Same result as as above: 
 - t_summer1.mean und snow winter2 correlated in male and female
 - r_newsummer1 and tautum.mean correlated in male and female
 
Again running 4 models for male and 4 models for female ommitting different combinations of collinear climate variables.

```{r,eval=FALSE}
M_x4.1 <-  gam(horn ~
                 s(Jday,bs="ts")+
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x4.1)#  11924.08

F_x4.1 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x4.1)#9924.199

#model omitting snow winter and tautumn.mean

M_x4.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x4.2)# 11924.08

F_x4.2 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=2, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 #s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)



AIC(F_x4.2)#9923.389

#omitting  tsummer1.mean and r_newsummer1

M_x4.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=male_db, REML=F)

AIC(M_x4.3)#11927.15 

F_x4.3 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts") +
                 s(tautumn.mean, k=3, bs="ts"),
               data=female_db, REML=F)



AIC(F_x4.3)# 9926.057

#############
#omitting  tsummer1.mean and tautumn.mean

M_x4.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)

AIC(M_x4.4)# 11924.93

F_x4.4 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(ndvi.m2s2.pc1,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
               #s(tautumn.mean, k=3, bs="ts")
               ,data=female_db, REML=F)

AIC(F_x4.4)#  9924.151
```
A look at the summary for significance
```{r}
summary(F_x4.4)
```
### Elevation

Model including elevation instead of NDVI PCA

Collinearity check:
```{r}
vMq <- as.formula(horn ~
                     
                     Jday +
                     f.substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     q_media + 
                     snow_winter1 +
                     snow_winter2 +
                     #r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     #tsummer1.mean +
                     tsummer2.mean 
                     #tautumn.mean
                  )

plot(varclus(vMq, data=male_db))
abline(h=0.5,col="red")

vFq <- as.formula(horn ~
                    
                    Jday +
                    f.substrate +
                    year +
                    council_cod +
                    weight +
                    density +
                    log.ndvi.slop1 +
                    log.ndvi.slop2 +
                    ndvi.maxincr1 +
                    ndvi.maxincr2 +
                    q_media + 
                    snow_winter1 +
                    snow_winter2 +
                    #r_newsummer1 +
                    r_newsummer2 +
                    twinter.mean1 +
                    twinter.mean2 +
                    tspring1.mean +
                    tspring2.mean +
                    #tsummer1.mean +
                    tsummer2.mean 
                    #tautumn.mean
                    )

plot(varclus(vFq, data=female_db))
abline(h=0.5,col="red")
```

Three variables had been ommitted because of collinearity. Models for male and for female:

```{r,eval=FALSE}
Mq1 <-  gam(horn ~
                 s(Jday,bs="ts") +
                 f.substrate +
                 s(f.year, bs="re") +
                 s(f.council_cod, bs="re") +
                 s(weight, bs="ts") +
                 s(density,k=3, bs="ts") +
                 s(log.ndvi.slop1, bs="ts") +
                 s(log.ndvi.slop2, bs="ts") +
                 s(ndvi.maxincr1, bs="ts") +
                 s(ndvi.maxincr2,k=4, bs="ts") +
                 s(q_media,k=4, bs="ts") +
                 s(snow_winter1, k=3, bs="ts") +
                 s(snow_winter2, k=3, bs="ts") +
                 #s(r_newsummer1, k=3, bs="ts") +
                 s(r_newsummer2, k=3, bs="ts") +
                 s(twinter.mean1, k=3, bs="ts") +
                 s(twinter.mean2, k=3, bs="ts") +
                 s(tspring1.mean, k=3, bs="ts") +
                 s(tspring2.mean, k=3, bs="ts") +
                 #s(tsummer1.mean, k=3, bs="ts") +
                 s(tsummer2.mean, k=3, bs="ts")
                 #s(tautumn.mean, k=3, bs="ts")
               ,data=male_db, REML=F)





AIC(Mq1)#11928.13


Fq1 <-  gam(horn ~
              s(Jday,bs="ts") +
              f.substrate +
              s(f.year, bs="re") +
              s(f.council_cod, bs="re") +
              s(weight, bs="ts") +
              s(density,k=3, bs="ts") +
              s(log.ndvi.slop1, bs="ts") +
              s(log.ndvi.slop2, bs="ts") +
              s(ndvi.maxincr1, bs="ts") +
              s(ndvi.maxincr2,k=4, bs="ts") +
              s(q_media,k=4, bs="ts") +
              s(snow_winter1, k=3, bs="ts") +
              s(snow_winter2, k=3, bs="ts") +
              #s(r_newsummer1, k=3, bs="ts") +
              s(r_newsummer2, k=3, bs="ts") +
              s(twinter.mean1, k=3, bs="ts") +
              s(twinter.mean2, k=3, bs="ts") +
              s(tspring1.mean, k=3, bs="ts") +
              s(tspring2.mean, k=3, bs="ts") +
              #s(tsummer1.mean, k=3, bs="ts") +
              s(tsummer2.mean, k=3, bs="ts")
              #s(tautumn.mean, k=3, bs="ts")
            ,data=female_db, REML=F)

#q_media k=4 applied 
AIC(Fq1)# 9922.87
summary(Fq1)
```

For q_media bs="ts" would be sufficient in the male model but in both sexes  k=4 was set because of necessarity in the female model

```{r}
par(mfrow=c(1,1))
plot(Fq1,select = 10)

```

### Open area

Variable percentage of open area replaces the variable elevation in the model.

Check for collinearity:

```{r}
vMaa <- as.formula(horn ~
                    
                    Jday +
                    f.substrate +
                    year +
                    council_cod +
                    weight +
                    density +
                    log.ndvi.slop1 +
                    log.ndvi.slop2 +
                    ndvi.maxincr1 +
                    ndvi.maxincr2 +
                    Perc.area.aperta + 
                    snow_winter1 +
                    snow_winter2 +
                    #r_newsummer1 +
                    r_newsummer2 +
                    twinter.mean1 +
                    twinter.mean2 +
                    tspring1.mean +
                    tspring2.mean +
                    #tsummer1.mean +
                    tsummer2.mean 
                   #tautumn.mean
)

plot(varclus(vMaa, data=male_db))
abline(h=0.5,col="red")

vFaa <- as.formula(horn ~
                     
                     Jday +
                     f.substrate +
                     year +
                     council_cod +
                     weight +
                     density +
                     log.ndvi.slop1 +
                     log.ndvi.slop2 +
                     ndvi.maxincr1 +
                     ndvi.maxincr2 +
                     Perc.area.aperta + 
                     snow_winter1 +
                     snow_winter2 +
                     #r_newsummer1 +
                     r_newsummer2 +
                     twinter.mean1 +
                     twinter.mean2 +
                     tspring1.mean +
                     tspring2.mean +
                     #tsummer1.mean +
                     tsummer2.mean 
                   #tautumn.mean
)

plot(varclus(vFaa, data=female_db))
abline(h=0.5,col="red")


```
All good

Male and female models:

```{r,eval=FALSE}
Maa1 <-  gam(horn ~
              s(Jday,bs="ts") +
              f.substrate +
              s(f.year, bs="re") +
              s(f.council_cod, bs="re") +
              s(weight, bs="ts") +
              s(density, k=3, bs="ts") +
              s(log.ndvi.slop1, bs="ts") +
              s(log.ndvi.slop2, bs="ts") +
              s(ndvi.maxincr1, bs="ts") +
              s(ndvi.maxincr2,k=4, bs="ts") +
              s(Perc.area.aperta,k=3, bs="ts") +
              s(snow_winter1, k=3, bs="ts") +
              s(snow_winter2, k=3, bs="ts") +
              #s(r_newsummer1, k=3, bs="ts") +
              s(r_newsummer2, k=3, bs="ts") +
              s(twinter.mean1, k=3, bs="ts") +
              s(twinter.mean2, k=3, bs="ts") +
              s(tspring1.mean, k=3, bs="ts") +
              s(tspring2.mean, k=3, bs="ts") +
              #s(tsummer1.mean, k=3, bs="ts") +
              s(tsummer2.mean, k=3, bs="ts")
            #s(tautumn.mean, k=3, bs="ts")
            ,data=male_db, REML=F)

AIC(Maa1)#11927.25
summary(Maa1)


```

```{r}
plot(Maa1,select = 10)
```

Perc_area_aperta k=3 is ok

```{r}
summary(Maa1)
```

Percentage of open area (Perc_area_aperta) is significant


```{r,eval=FALSE}
Faa1 <-  gam(horn ~
              s(Jday,bs="ts") +
              f.substrate +
              s(f.year, bs="re") +
              s(f.council_cod, bs="re") +
              s(weight, bs="ts") +
              s(density,k=3, bs="ts") +
              s(log.ndvi.slop1, bs="ts") +
              s(log.ndvi.slop2, bs="ts") +
              s(ndvi.maxincr1, bs="ts") +
              s(ndvi.maxincr2, bs="ts") +
              s(Perc.area.aperta,k=3, bs="ts") +
              s(snow_winter1, k=3, bs="ts") +
              s(snow_winter2, k=3, bs="ts") +
              #s(r_newsummer1, k=3, bs="ts") +
              s(r_newsummer2, k=3, bs="ts") +
              s(twinter.mean1, k=3, bs="ts") +
              s(twinter.mean2, k=3, bs="ts") +
              s(tspring1.mean, k=3, bs="ts") +
              s(tspring2.mean, k=3, bs="ts") +
              #s(tsummer1.mean, k=3, bs="ts") +
              s(tsummer2.mean, k=3, bs="ts")
              #s(tautumn.mean, k=3, bs="ts")
            ,data=female_db, REML=F)

```
k was reduced in M/Faa1 to k=3 because of a better modelling in the model for female (Faa1)
```{r}
plot(Faa1,select = 10)
gam.check(Faa1)
```

```{r}
shapiro.test(resid(Faa1))
```
ok


### Model comparison



```{r,message=FALSE,warnings=FALSE}
library(knitr)
```

Table of AIC´s:

 - m1m2 = models with NDVI May of first and second year
 - s1s2 = models with NDVI summer of first and second year
 - m1s1 = models with NDVI May and summer of the first year
 - m2s2 = models with NDVI May and summer of the second year
 
```{r}

load("aic_tab.RData")
kable(aic_tab)
```

Summary of the AICs of models of male chamois hornlength

```{r}

summary (aic_tab$AIC_male)
```

Summary of AICs of the models of female chamois hornlength

```{r}
summary (aic_tab$AIC_female)
```

### Summary

Different variables which had been identified as relevant for the horn length by the randomForest analysis had been tested in separate male and female models.The AIC values of the different models are very similar within each sex.
The resulting AIC´s did not underpin a hypothesis of differences in the effect of the investigated environmental variables regarding male or female chamois hornlength.

# Conclusion

The data set we received included 2679 samples of horn lengths of legally hunted Chamois. Most of the predictors were at council or area level or even on a larger regional scale.

Our hypotheses that there is a difference in environmental predictors for horn length between male and female Chamois could not be supported by the data. We followed to approaches: One was to build parallel full models for males and females and compare the AIC between models with replaced predictors. The other was to build a small model with the most important predictors sex, weight and Julian day and then add single predictors to check for their explanatory power. Both approaches led to the same conclusion that did not suggest a difference in environmental predictors for male and female horn size.

The only predictor we found that had an significant influence between sexes was weight.

```{r, echo=FALSE}
db_male <- db[db$f.sex=="male", ]
db_female <- db[db$f.sex=="female", ]
f_weight <- seq(from=min(db_female$weight), to=max(db_female$weight), len=100)
m_weight <- seq(from=min(db_male$weight), to=max(db_male$weight), len=100)

female.preds <- predict(fcham_t4, newdata = data.frame("weight"=f_weight, "f.sex"="female", "f.year"=median(db_female$year), "Jday"=mean(db_female$Jday), "f.council_cod"=median(db_female$council_cod)), se=T)

male.preds <- predict(fcham_t4, newdata = data.frame("weight"=m_weight, "f.sex"="male", "f.year"=median(db_male$year), "Jday"=mean(db_male$Jday), "f.council_cod"=median(db_male$council_cod)), se=T)


plot(horn ~ weight, cex=0.5, type="n", data=db, xlab="Weight [kg]", ylab="Horn length [mm]")

with(db_female, points(weight + 0.05, horn, col="pink"))
with(db_male, points(weight - 0.05, horn, col="lightskyblue"))
lines(male.preds$fit ~ m_weight, col="lightskyblue2", lwd=2)
lines(male.preds$fit - 1.96*male.preds$se.fit ~ m_weight, col="black", lty=2)
lines(male.preds$fit + 1.96*male.preds$se.fit ~ m_weight, col="black", lty=2)

lines(female.preds$fit ~ f_weight, col="pink1", lwd=2)
lines(female.preds$fit - 1.96*female.preds$se.fit ~ f_weight, col="black", lty=2)
lines(female.preds$fit + 1.96*female.preds$se.fit ~ f_weight, col="black", lty=2)
legend("topleft",lwd=c(2,2,2), lty= c(1,1, 2),col=c("pink","lightskyblue2", "black"),legend=c("female", "male", "95% conf Int"), bty="n")


```

We interprete this that males invest more in horn growth when they are heavier than females with the same weight do. On the other hand, females which are heavy and have the ressources to invest in horn choose to invest somewhere else. With the data we did not find any environmental factors that drive the differnce in horn size between sexes.

Further investigations should collect more environmental data with higher spatial resolution to better reflect variability in the landscape. 
